
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<div class="table-wrapper" [style.max-height.px]="maxHeight">
  @if (loading) {
    <div class="loading-overlay" role="status" aria-live="polite">
      <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
    </div>
  }

  <!-- Barre d’actions -->
  @if (showColumnMenu) {
    <div class="table-actions">
      <button mat-stroked-button [matMenuTriggerFor]="colMenu">
        <mat-icon>view_column</mat-icon>
        Colonnes
      </button>

      <mat-menu #colMenu="matMenu" class="columns-menu">
        @for (col of _columns; track col.nom) {
          <button mat-menu-item (click)="$event.stopPropagation()">
            <mat-checkbox
              [checked]="!isHidden(col)"
              [disabled]="!col.retractable"
              (change)="toggleColumn(col)">
              {{ col.label }}
            </mat-checkbox>
          </button>
        }
      </mat-menu>
    </div>
  }

  <table mat-table [dataSource]="dataSource" class="mat-elevation-z8" matSort>
    <!-- Colonnes dynamiques (1 th + 1 td par colonne) -->
    @for (col of visibleColumnDefs; track col.nom) {
      <ng-container [matColumnDef]="col.nom">
        <th mat-header-cell *matHeaderCellDef
            mat-sort-header
            [disabled]="!(enableOrder && col.enableOrder)">
          {{ col.label }}
        </th>

        @switch (col.type) {
          @case (TableDataType.STRING)   { <td mat-cell class="data-table-colonne-{{ col.nom }}">{{ row[col.nom] }}</td> }
          @case (TableDataType.NUMBER)   { <td mat-cell class="data-table-colonne-{{ col.nom }}">{{ row[col.nom] }}</td> }
          @case (TableDataType.BOOLEAN)  { <td mat-cell class="data-table-colonne-{{ col.nom }}">{{ row[col.nom] }}</td> }
          @case (TableDataType.DATE)     { <td mat-cell class="data-table-colonne-{{ col.nom }}">{{ row[col.nom] | date:'dd/MM/yyyy' }}</td> }
          @case (TableDataType.TIME)     { <td mat-cell class="data-table-colonne-{{ col.nom }}">{{ row[col.nom] | date:'HH:mm:ss' }}</td> }
          @case (TableDataType.DATETIME) { <td mat-cell class="data-table-colonne-{{ col.nom }}">{{ row[col.nom] | date:'dd/MM/yyyy HH:mm:ss' }}</td> }
          @case (TableDataType.JSON)     { <td mat-cell class="data-table-colonne-{{ col.nom }}">{{ row[col.nom] | json }}</td> }
          @case (TableDataType.OBJECT)   { <td mat-cell class="data-table-colonne-{{ col.nom }}">{{ row[col.nom] }}</td> }
          @case (TableDataType.LINK)     {
            <td mat-cell class="data-table-colonne-{{ col.nom }}">
              <a class="lien-url" [routerLink]="[col.link, row[col.nom]]">{{ row[col.nom] }}</a>
            </td>
          }
          @default { <td mat-cell class="data-table-colonne-{{ col.nom }}">{{ row[col.nom] }}</td> }
        }
      </ng-container>
    }

    <tr mat-header-row *matHeaderRowDef="displayedColumns" [class.sticky]="stickyHeader"></tr>
    <tr mat-row        *matRowDef="let row; columns: displayedColumns"></tr>

    @if (!loading && (serverSide ? total : autoLength) === 0) {
      <tr class="mat-row">
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">Aucune donnée</td>
      </tr>
    }
  </table>

  <mat-paginator
    [length]="serverSide ? total : autoLength"
    [pageSize]="pageSize"
    [pageSizeOptions]="pageSizeOptions"
    showFirstLastButtons>
  </mat-paginator>
</div>




.table-wrapper {
  position: relative;
  overflow: auto;
}

.table-actions {
  display: flex;
  gap: .5rem;
  align-items: center;
  padding: .5rem 0;
}

.loading-overlay {
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  background: rgba(255, 255, 255, 0.6);
  z-index: 2;
}

.sticky,
.mat-mdc-header-row.sticky {
  position: sticky;
  top: 0;
  z-index: 1;
  background: #fff;
}

table { width: 100%; }



<lib-data-table
  [data]="rows"
  [columns]="columns"
  [hiddenColumns]="['amount']"
  [enableOrder]="true"
  [loading]="loading"
  [showHeaderSpinner]="false">
</lib-data-table>

<lib-data-table
  [data]="rows"
  [columns]="columns"
  [(hiddenColumns)]="hiddenColumns"  <!-- récupère l’état -->
  [enableOrder]="true"
  [loading]="loading"
  [maxHeight]="520">
</lib-data-table>

hiddenColumns: string[] = ['amount']; // ex. masquée par défaut